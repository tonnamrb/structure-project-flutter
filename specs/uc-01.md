# UC-01 Sign up with Google

## Header
- UC ID: UC-01
- Module: Authentication
- Wireframe: ./wireframes/UC-01_sign_up_with_google.png
- Priority: P1
- Risk: Medium

## Preconditions
- ผู้ใช้ยังไม่มีบัญชีในระบบ
- ระบบตั้งค่า Google OAuth `client_id`, `redirect_uri`, `scope=email, profile` แล้ว

## Screen Mapping
| SC | Screen ID            |
|----|----------------------|
| 1  | scr-onboarding       |
| 2  | scr-signup-choice    |
| 3  | scr-google-consent   |
| 4  | scr-signup-cancelled |
| 5  | scr-signup-form      |
| 6  | scr-home             |
| 7  | scr-albums           |

## Element Mapping
| ID | Element              | Screen | FRD Step  | TC IDs            | Tokens         |
|----|----------------------|--------|-----------|-------------------|----------------|
| 1  | btn-signup           | SC-1   | step-1    | –                 | primary        |
| 2  | btn-google           | SC-2   | step-1..3 | 01-1,02,04,05,13,14 | brand.google |
| 3  | btn-cancel           | SC-3   | alt       | 01-1              | secondary      |
| 4  | scr-signup-cancelled | SC-4   | alt       | 01-1              | text_primary   |
| 5  | consent-continue     | SC-3   | step-2..3 | –                 | dialog_primary |
| 6  | btn-continue         | SC-5   | step-6..8 | 01-6..12,17       | primary        |
| 7  | toast/validation     | SC-5   | exception | 01-6..16          | error,info,success |

## Main Flow
1. SC-1.btn-signup → SC-2
2. SC-2.btn-google → SC-3
3. SC-3.consent-continue → SC-5
4. SC-5 กรอก Displayname, DOB, Gender
5. SC-5 ติ๊กยอมรับ ToS/PDPA
6. SC-5.btn-continue(valid) → SC-6 + toast_success
7. SC-6 → state=logged_in

## Transition Mapping
- SC-3.btn-cancel → SC-4
- SC-5.btn-continue(invalid fields) → SC-5.toast_error
- SC-5.btn-continue(no ToS) → SC-5.inline_error
- SC-5.btn-continue(double submit) → SC-5.toast_info

## Exception Mapping (Test Cases)
- 01-1 → cancel → SC-4 | Toast: "Sign up canceled."
- 01-2 → token invalid → SC-5.toast_error | "Authentication failed."
- 01-3 → duplicate email → SC-6 (treat as login)
- 01-4 → missing scope email → SC-3.dialog_error | "Cannot sign up without email permission."
- 01-5 → token reuse (replay) → SC-5.toast_error | "Invalid request."
- 01-6 → missing required fields → SC-5.inline_error
- 01-7 → duplicate displayname → SC-5.toast_error
- 01-8 → displayname > 30 chars → SC-5.truncate
- 01-9 → ToS/PDPA not accepted → SC-5.inline_error
- 01-10 → displayname invalid chars → SC-5.inline_error
- 01-11 → DOB in the future → SC-5.inline_error
- 01-12 → double submit → SC-5.toast_info
- 01-13 → OAuth `state` mismatch → SC-3.dialog_error
- 01-14 → PKCE invalid → SC-3.dialog_error
- 01-15 → Google email not verified → SC-3.dialog_error
- 01-16 → token exchange timeout → SC-5.toast_error (show retry)
- 01-17 → open ToS/Privacy link → in-app browser

## Business Rules
- ใช้ Google OAuth 2.0 (`scope=email, profile`)
- Email ต้อง unique
- ต้องยอมรับ PDPA ก่อนสมัคร
- บันทึก audit log ทุกครั้ง

## Postconditions
- สร้างบัญชี + ผูก provider_id (ถ้าเป็นผู้ใช้ใหม่)
- สร้าง session และพาไปหน้า Home
- บันทึก PDPA consent + audit log
